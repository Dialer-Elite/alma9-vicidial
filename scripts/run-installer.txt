#!/bin/bash
# Run after reboot. Constants feed main-installer prompts (no typing). Edit consts, run as root.
set -e

INSTALL_DIR="/usr/src/vicidial-install-scripts"
STATE_FILE="/root/vicidial-alma9-setup/.prep-state"
RESPONSE_FILE="/root/vicidial-alma9-setup/main-installer-responses.txt"

# =============================================================================
# Constants. Order: hostname, 5x Enter, (mysql uses MYSQL_PWD), DOMAINNAME for webrtc, 1x Enter (reboot).
# =============================================================================
DEFAULT_ROLE="dbweb"
DEFAULT_INSTALLER_HOSTNAME="as-medi1.dialerelite.com"
DEFAULT_MYSQL_ROOT_PASSWORD="ViciDB_6y5e1v_e6W"
DEFAULT_SSL_EMAIL="info@dialerelite.com"
# For asterisk role only
DEFAULT_DB_SERVER_IP=""

unset ROLE INSTALLER_HOSTNAME MYSQL_ROOT_PASSWORD SSL_EMAIL DB_SERVER_IP
[[ "$EUID" -eq 0 ]] || { echo "Run as root." >&2; exit 1; }

while [[ $# -gt 0 ]]; do
  case "$1" in
    --role=*)              ROLE="${1#*=}" ;;
    --hostname=*)          INSTALLER_HOSTNAME="${1#*=}" ;;
    --mysql-password=*)    MYSQL_ROOT_PASSWORD="${1#*=}" ;;
    --ssl-email=*)         SSL_EMAIL="${1#*=}" ;;
    --db-server-ip=*)      DB_SERVER_IP="${1#*=}" ;;
    -h|--help)             echo "Usage: $0 [--role=dbweb|asterisk] [--hostname=NAME] [--mysql-password=PWD] [--ssl-email=EMAIL] [--db-server-ip=IP]"; exit 0 ;;
    *) echo "Unknown: $1" >&2; exit 1 ;;
  esac
  shift
done

if [[ -f "$STATE_FILE" ]]; then
  . "$STATE_FILE" 2>/dev/null || true
fi
ROLE="${ROLE:-$DEFAULT_ROLE}"
INSTALLER_HOSTNAME="${INSTALLER_HOSTNAME:-${FQDN:-$DEFAULT_INSTALLER_HOSTNAME}}"
MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD:-$DEFAULT_MYSQL_ROOT_PASSWORD}"
SSL_EMAIL="${SSL_EMAIL:-$DEFAULT_SSL_EMAIL}"
DB_SERVER_IP="${DB_SERVER_IP:-$DEFAULT_DB_SERVER_IP}"

[[ -d "$INSTALL_DIR" ]] || { echo "Missing $INSTALL_DIR. Run prepare-and-install.sh, then reboot." >&2; exit 1; }
cd "$INSTALL_DIR"

if [[ "$ROLE" == "dbweb" ]]; then
  if [[ -n "$MYSQL_ROOT_PASSWORD" ]]; then
    export MYSQL_PWD="$MYSQL_ROOT_PASSWORD"
  fi
  # Patch webrtc script so certbot uses --email and --agree-tos when SSL_EMAIL set
  if [[ -n "$SSL_EMAIL" ]] && [[ -f "$INSTALL_DIR/vicidial-enable-webrtc.sh" ]]; then
    sed -i.bak 's|certbot --apache -d $DOMAINNAME|& --email '"$SSL_EMAIL"' --agree-tos|' "$INSTALL_DIR/vicidial-enable-webrtc.sh"
  fi
  # Prompts: 1 hostname, 5x "Press Enter", (mysql), "read DOMAINNAME" in webrtc, 1x "Press Enter to Reboot"
  printf '%s\n\n\n\n\n%s\n\n' "$INSTALLER_HOSTNAME" "$INSTALLER_HOSTNAME" > "$RESPONSE_FILE"
  < "$RESPONSE_FILE" ./main-installer.sh
  rm -f "$RESPONSE_FILE"
  [[ -f "$INSTALL_DIR/vicidial-enable-webrtc.sh.bak" ]] && mv "$INSTALL_DIR/vicidial-enable-webrtc.sh.bak" "$INSTALL_DIR/vicidial-enable-webrtc.sh"
  unset MYSQL_PWD
elif [[ "$ROLE" == "asterisk" ]]; then
  [[ -z "$DB_SERVER_IP" ]] && { echo "Set DEFAULT_DB_SERVER_IP or --db-server-ip." >&2; exit 1; }
  ./addon-dialer-alma9.sh
  echo "$DB_SERVER_IP" | ./run-on-dialer-servers-cluster.sh
else
  echo "Invalid ROLE." >&2
  exit 1
fi
