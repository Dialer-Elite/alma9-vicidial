# No Sound on Agent Login and Phone Register — Issue and Fix

This document explains why there was no audio (dial tone, “You are currently the only person in this conference,” or any dialer sounds) when agents logged in and when phones registered, and what was changed to fix it.

---

## Summary of the Problem

- **Symptom:** After registering the webphone and logging in as an agent, there was no sound from the dialer (no dial tone, no conference welcome message, no IVR/prompts).
- **Environment:** VICIDial on Asterisk; agent phones are WebRTC (chan_sip over WSS); server public IP: **46.224.194.184**; RTP ports 10000–20000/udp were already open in the firewall.

---

## Root Causes

### 1. chan_sip Had No External IP (RTP/SDP)

**What was wrong**

- In `sip.conf` **[general]**, neither `externip` nor `externhost` was set.
- Asterisk therefore put the wrong address in the SDP sent to the phone (e.g. `0.0.0.0` or a non-routable interface IP).
- The phone sent RTP to that address; from the internet, that address was not reachable, so **no RTP reached the server → no audio**.

**Why it matters**

- For SIP, the SDP tells the phone where to send media (RTP). If the server is behind NAT or has multiple interfaces, it must advertise its **public** IP so remote phones send RTP to the right place.

**Fix applied**

- In **`/etc/asterisk/sip.conf`** **[general]**:
  - Added: **`externip=46.224.194.184`**

---

### 2. PJSIP Used Placeholder `SERVER_EXTERNAL_IP`

**What was wrong**

- In **`/etc/asterisk/pjsip.conf`** **[transport-udp]**:
  - `external_media_address = SERVER_EXTERNAL_IP`
  - `external_signaling_address = SERVER_EXTERNAL_IP`
- Asterisk logs showed:  
  `getaddrinfo("SERVER_EXTERNAL_IP", "(null)", ...): Name or service not known`
- So the media/signaling addresses were invalid; any PJSIP/WebRTC usage could have wrong SDP and no working media path.

**Fix applied**

- In **`/etc/asterisk/pjsip.conf`** **[transport-udp]**:
  - Replaced both with: **`46.224.194.184`**

---

### 3. Wrong DTLS Certificate Path for WebRTC (chan_sip)

**What was wrong**

- In **`/etc/asterisk/sip-vicidial.conf`**, WebRTC peers (e.g. 898989, 391965) had:
  - `dtlscertfile=/etc/letsencrypt/live/as-medi1.dialerelite.com/cert.pem`
  - `dtlsprivatekey=/etc/letsencrypt/live/as-medi1.dialerelite.com/privkey.pem`
- The actual LetsEncrypt directory on the server is:  
  **`/etc/letsencrypt/live/as-medi1-d1.dialerelite.com/`** (with **-d1**).
- Asterisk logs showed:  
  `dtlscertfile file /etc/letsencrypt/live/as-medi1.dialerelite.com/cert.pem does not exist or is not readable`
- So DTLS for WebRTC could not start → no secure media path → **no sound** on WebRTC agent phones.

**Fix applied**

- In **`/etc/asterisk/sip-vicidial.conf`**:
  - Replaced all occurrences of **`as-medi1.dialerelite.com`** with **`as-medi1-d1.dialerelite.com`** in the DTLS paths (for all affected peers).

---

## Changes Summary Table

| File | Section / Item | Before | After |
|------|----------------|--------|--------|
| **sip.conf** | [general] | No `externip` | `externip=46.224.194.184` |
| **pjsip.conf** | [transport-udp] | `external_media_address = SERVER_EXTERNAL_IP` | `external_media_address = 46.224.194.184` |
| **pjsip.conf** | [transport-udp] | `external_signaling_address = SERVER_EXTERNAL_IP` | `external_signaling_address = 46.224.194.184` |
| **sip-vicidial.conf** | DTLS paths (all peers) | `.../as-medi1.dialerelite.com/...` | `.../as-medi1-d1.dialerelite.com/...` |

---

## Post-Change Steps Performed

- **`asterisk -rx "sip reload"`** — so chan_sip and sip-vicidial.conf changes (externip, DTLS paths) are active.
- RTP ports **10000–20000/udp** were already open in the firewall; no change needed there.

---

## Important Notes

1. **sip-vicidial.conf is auto-generated by VICIDial.**  
   If you run a conf rebuild (e.g. Admin → Servers → Rebuild Conf), the DTLS paths may be overwritten. To make the fix permanent, update the **phone template** (or whatever generates the WebRTC/DTLS settings) in VICIDial so it uses **`as-medi1-d1.dialerelite.com`** instead of `as-medi1.dialerelite.com`.

2. **If the server’s public IP changes**, update:
   - **sip.conf:** `externip=46.224.194.184` → new IP
   - **pjsip.conf:** both `external_media_address` and `external_signaling_address` → new IP  
   Then run `sip reload` and, if using PJSIP, `pjsip reload`.

3. **RTP port range** is defined in **`/etc/asterisk/rtp.conf`** (`rtpstart=10000`, `rtpend=20000`) and must be allowed in the firewall (e.g. `firewall-cmd --permanent --add-port=10000-20000/udp`), which was already in place.

---

## How to Verify

- Register the webphone and log in as an agent.
- You should hear:
  - Dial tone when ready to dial.
  - “You are currently the only person in this conference” when alone in the agent conference (if that prompt is enabled).
  - Any IVR or dialer prompts as configured.

If there is still no sound, check Asterisk logs for RTP/DTLS errors and ensure the phone is using the same codecs as Asterisk (e.g. ulaw/gsm) and that no other firewall or NAT is blocking RTP to 46.224.194.184:10000–20000.
